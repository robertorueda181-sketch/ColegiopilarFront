<p-toast></p-toast>

<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2 class="m-0">Gestión de Pagos</h2>
        <button pButton label="Nuevo Pago" icon="pi pi-plus" (click)="showDialog()"></button>
    </div>

    <p-table [value]="pagos()" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header">
            <tr>
                <th>Estudiante</th>
                <th>Monto</th>
                <th>Tipo</th>
                <th>Método</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Comprobante</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-pago>
            <tr>
                <td>{{pago.nombreEstudiante}}</td>
                <td>{{pago.monto | currency:'PEN'}}</td>
                <td>
                    <span [class]="'badge-tipo ' + pago.tipo.toLowerCase()">{{pago.tipo}}</span>
                </td>
                <td>{{pago.metodo}}</td>
                <td>{{pago.fecha | date:'shortDate'}}</td>
                <td>
                    <p-tag [value]="pago.estado" [severity]="getSeverity(pago.estado)"></p-tag>
                </td>
                <td>
                    <a *ngIf="pago.archivoUrl" [href]="pago.archivoUrl" target="_blank" pButton icon="pi pi-file" class="p-button-rounded p-button-text p-button-sm"></a>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog header="Registrar Nuevo Pago" [(visible)]="displayDialog" [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    <div class="field grid">
        <label for="estudiante" class="col-12 mb-2 md:col-2 md:mb-0">Estudiante</label>
        <div class="col-12 md:col-10">
            <p-select [options]="estudiantes()" [(ngModel)]="selectedEstudiante" placeholder="Seleccione un estudiante" [style]="{'width':'100%'}" appendTo="body" [filter]="true" filterBy="label"></p-select>
        </div>
    </div>

    <div class="field grid mt-3">
        <label class="col-12 mb-2 md:col-2 md:mb-0">Tipo de Pago</label>
        <div class="col-12 md:col-10 flex gap-3">
            <div class="field-radiobutton">
                <p-radioButton name="tipo" value="PARCIAL" [(ngModel)]="tipoPago" inputId="parcial"></p-radioButton>
                <label for="parcial" class="ml-2">Parcial</label>
            </div>
            <div class="field-radiobutton">
                <p-radioButton name="tipo" value="TOTAL" [(ngModel)]="tipoPago" inputId="total"></p-radioButton>
                <label for="total" class="ml-2">Total</label>
            </div>
        </div>
    </div>

    <div class="field grid mt-3">
        <label for="monto" class="col-12 mb-2 md:col-2 md:mb-0">Monto</label>
        <div class="col-12 md:col-10">
            <p-inputNumber [(ngModel)]="monto" mode="currency" currency="PEN" locale="es-PE" [min]="0" styleClass="w-full"></p-inputNumber>
        </div>
    </div>

    <div class="field grid mt-3">
        <label class="col-12 mb-2 md:col-2 md:mb-0">Comprobante (Yape/PDF)</label>
        <div class="col-12 md:col-10">
            <p-fileUpload mode="advanced" chooseLabel="Seleccionar" uploadLabel="Cargar" cancelLabel="Cancelar" 
                [multiple]="false" accept="image/*,.pdf" [maxFileSize]="1000000" 
                (onUpload)="onUpload($event)" [auto]="true" [customUpload]="true" (uploadHandler)="onUpload($event)">
            </p-fileUpload>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Guardar" icon="pi pi-check" (click)="guardarPago()"></button>
    </ng-template>
</p-dialog>
