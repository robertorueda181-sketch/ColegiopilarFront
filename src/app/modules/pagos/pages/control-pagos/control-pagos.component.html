<p-toast></p-toast>

<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2 class="m-0">Gestión de Pagos</h2>
    </div>

    <div class="mb-4">
        <label class="block mb-2">Filtrar por Tarifa</label>
        <p-select [options]="tarifasOptions()" [(ngModel)]="selectedTarifaId" placeholder="Seleccione tarifa" (ngModelChange)="onTarifaChange($event)" style="width: 300px"></p-select>
    </div>

    <!-- Column filters are shown inside the table header -->

    <!-- global search and reset will be shown inside the table caption to ensure template ref access -->

        <h3 class="mb-4">Matriculas por Tarifa</h3>
        
        <!-- Global Search Bar -->
        <div class="mb-4">
            <input pInputText type="text" placeholder="Buscar por DNI, nombre, grado, sección, nivel o monto..." (input)="onSearchChange($event)" class="w-full" />
        </div>

        <!-- Data Table -->
        <p-table #dt [value]="filteredMatriculas()" [paginator]="true" [rows]="10" responsiveLayout="scroll" styleClass="p-datatable-striped">
            <ng-template pTemplate="header">
                <tr>
                    <th>Pagar</th>
                    <th>DNI</th>
                    <th>Estudiante</th>
                    <th>
                        <div class="filter-header" (click)="toggleFilter('grado'); $event.stopPropagation()">
                            <span>Grado</span>
                            <i class="pi pi-filter filter-icon" [class.active]="filtroGrado()" [ngClass]="{'text-blue-500': filtroGrado()}"></i>
                        </div>
                        <div class="filter-dropdown" *ngIf="showFilterGrado()">
                            <p-select [options]="gradosOptions()" [ngModel]="filtroGrado()" placeholder="Selecciona Grado" (ngModelChange)="aplicarFiltroSelect($any(null), 'grado', $event); closeFilters()" [showClear]="true" style="width: 100%"></p-select>
                        </div>
                    </th>
                    <th>
                        <div class="filter-header" (click)="toggleFilter('seccion'); $event.stopPropagation()">
                            <span>Sección</span>
                            <i class="pi pi-filter filter-icon" [class.active]="filtroSeccion()" [ngClass]="{'text-blue-500': filtroSeccion()}"></i>
                        </div>
                        <div class="filter-dropdown" *ngIf="showFilterSeccion()">
                            <p-select [options]="seccionesOptions()" [ngModel]="filtroSeccion()" placeholder="Selecciona Sección" (ngModelChange)="aplicarFiltroSelect($any(null), 'seccion', $event); closeFilters()" [showClear]="true" style="width: 100%"></p-select>
                        </div>
                    </th>
                    <th>
                        <div class="filter-header" (click)="toggleFilter('nivel'); $event.stopPropagation()">
                            <span>Nivel</span>
                            <i class="pi pi-filter filter-icon" [class.active]="filtroNivel()" [ngClass]="{'text-blue-500': filtroNivel()}"></i>
                        </div>
                        <div class="filter-dropdown" *ngIf="showFilterNivel()">
                            <p-select [options]="nivelesOptions()" [ngModel]="filtroNivel()" placeholder="Selecciona Nivel" (ngModelChange)="aplicarFiltroSelect($any(null), 'nivel', $event); closeFilters()" [showClear]="true" style="width: 100%"></p-select>
                        </div>
                    </th>
                    <th>Monto Final</th>
                    <th>Monto Pagado</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-m>
                <tr [class.falta-pago]="m.pagoMonto < m.montoFinal" [class.pagado]="m.pagoMonto >= m.montoFinal">
                    <td>
                        <button pButton icon="pi pi-money-bill" class="p-button-rounded p-button-sm p-button-info" (click)="pagar(m)"></button>
                    </td>
                    <td>{{m.dni}}</td>
                    <td>{{m.nombres}} {{m.apellidos}}</td>
                    <td>{{m.grado}}</td>
                    <td>{{m.seccion}}</td>
                    <td>{{m.nivel}}</td>
                    <td>{{m.montoFinal | currency:'PEN'}}</td>
                    <td>{{m.pagoMonto | currency:'PEN'}}</td>
                </tr>
            </ng-template>
        </p-table>
        
        <!-- Botón Limpiar Filtros -->
        <div class="mt-3" *ngIf="filtroGrado() || filtroSeccion() || filtroNivel()">
            <button pButton label="Limpiar filtros" icon="pi pi-times" class="p-button-sm" (click)="resetFilters()"></button>
        </div>
    </div>

<p-dialog header="Registrar Nuevo Pago" [(visible)]="displayDialog" [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    <div class="field grid">
        <label for="estudiante" class="col-12 mb-2 md:col-2 md:mb-0">Estudiante</label>
        <div class="col-12 md:col-10">
            <p-select [options]="estudiantes()" [(ngModel)]="selectedEstudiante" placeholder="Seleccione un estudiante" [style]="{'width':'100%'}" appendTo="body" [filter]="true" filterBy="label"></p-select>
        </div>
    </div>

    <div class="field grid mt-3">
        <label class="col-12 mb-2 md:col-2 md:mb-0">Tipo de Pago</label>
        <div class="col-12 md:col-10 flex gap-3">
            <div class="field-radiobutton">
                <p-radioButton name="tipo" value="PARCIAL" [(ngModel)]="tipoPago" inputId="parcial"></p-radioButton>
                <label for="parcial" class="ml-2">Parcial</label>
            </div>
            <div class="field-radiobutton">
                <p-radioButton name="tipo" value="TOTAL" [(ngModel)]="tipoPago" inputId="total"></p-radioButton>
                <label for="total" class="ml-2">Total</label>
            </div>
        </div>
    </div>

    <div class="field grid mt-3">
        <label for="monto" class="col-12 mb-2 md:col-2 md:mb-0">Monto</label>
        <div class="col-12 md:col-10">
            <p-inputNumber [(ngModel)]="monto" mode="currency" currency="PEN" locale="es-PE" [min]="0" styleClass="w-full"></p-inputNumber>
        </div>
    </div>

    <div class="field grid mt-3">
        <label class="col-12 mb-2 md:col-2 md:mb-0">Comprobante (Yape/PDF)</label>
        <div class="col-12 md:col-10">
            <p-fileUpload mode="advanced" chooseLabel="Seleccionar" uploadLabel="Cargar" cancelLabel="Cancelar" 
                [multiple]="false" accept="image/*,.pdf" [maxFileSize]="1000000" 
                (onUpload)="onUpload($event)" [auto]="true" [customUpload]="true" (uploadHandler)="onUpload($event)">
            </p-fileUpload>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Guardar" icon="pi pi-check" (click)="guardarPago()"></button>
    </ng-template>
</p-dialog>
